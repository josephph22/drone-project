#include <Servo.h>
#include <Wire.h>
#include <MPU6050.h>

MPU6050 mpu;

float accelOffsetX = 0, accelOffsetY = 0, accelOffsetZ = 0;
float gyroOffsetX = 0, gyroOffsetY = 0, gyroOffsetZ = 0;

float pitch = 0, roll = 0;
float temperature = 0;

Servo motorFL, motorFR, motorBL, motorBR;

const int BASE_THROTTLE = 1400;
const int MIN_THROTTLE = 1000, MAX_THROTTLE = 2000;

const float GYRO_WEIGHT = 0.98;
const float ACCEL_WEIGHT = 0.02;

const float PITCH_CORRECTION = 10.0;
const float ROLL_CORRECTION = 10.0;

unsigned long previousTime = 0;

void setup() {
    Serial.begin(115200);
    Wire.begin();
    mpu.initialize();
    attachMotors();
    calibrateMPU6050();
    armMotors();
    initializeMotors();
    Serial.println("Setup complete.");
}

void attachMotors() {
    motorFL.attach(5);
    motorFR.attach(9);
    motorBL.attach(10);
    motorBR.attach(11);
}

void calibrateMPU6050() {
    const int NUM_SAMPLES = 500;
    long accelSumX = 0, accelSumY = 0, accelSumZ = 0;
    long gyroSumX = 0, gyroSumY = 0, gyroSumZ = 0;
    Serial.println("Calibrating MPU6050...");
    for (int i = 0; i < NUM_SAMPLES; i++) {
        int16_t ax, ay, az, gx, gy, gz;
        mpu.getMotion6(&ax, &ay, &az, &gx, &gy, &gz);
        accelSumX += ax;
        accelSumY += ay;
        accelSumZ += az;
        gyroSumX += gx;
        gyroSumY += gy;
        gyroSumZ += gz;
        delay(2);
    }
    accelOffsetX = accelSumX / NUM_SAMPLES;
    accelOffsetY = accelSumY / NUM_SAMPLES;
    accelOffsetZ = (accelSumZ / NUM_SAMPLES) - 16384.0;
    gyroOffsetX = gyroSumX / NUM_SAMPLES;
    gyroOffsetY = gyroSumY / NUM_SAMPLES;
    gyroOffsetZ = gyroSumZ / NUM_SAMPLES;
    Serial.println("MPU6050 calibrated.");
}

void armMotors() {
    Serial.println("Arming motors...");
    motorFL.writeMicroseconds(MIN_THROTTLE);
    motorFR.writeMicroseconds(MIN_THROTTLE);
    motorBL.writeMicroseconds(MIN_THROTTLE);
    motorBR.writeMicroseconds(MIN_THROTTLE);
    delay(3000);
    Serial.println("Motors armed.");
}

void initializeMotors() {
    motorFL.writeMicroseconds(BASE_THROTTLE);
    motorFR.writeMicroseconds(BASE_THROTTLE);
    motorBL.writeMicroseconds(BASE_THROTTLE);
    motorBR.writeMicroseconds(BASE_THROTTLE);
}

void loop() {
    float deltaTime = calculateElapsedTime();
    updateAngles(deltaTime);
    updateTemperature();
    adjustMotorSpeeds();
}

float calculateElapsedTime() {
    unsigned long currentTime = micros();
    float deltaTime = (currentTime - previousTime) / 1000000.0;
    previousTime = currentTime;
    return deltaTime;
}

void updateAngles(float deltaTime) {
    int16_t ax, ay, az, gx, gy, gz;
    mpu.getMotion6(&ax, &ay, &az, &gx, &gy, &gz);
    float accelX = (ax - accelOffsetX) / 16384.0;
    float accelY = (ay - accelOffsetY) / 16384.0;
    float accelZ = (az - accelOffsetZ) / 16384.0;
    float magnitude = sqrt(accelX * accelX + accelY * accelY + accelZ * accelZ);
    accelX /= magnitude;
    accelY /= magnitude;
    accelZ /= magnitude;
    float gyroX = (gx - gyroOffsetX) / 131.0;
    float gyroY = (gy - gyroOffsetY) / 131.0;
    float accelPitch = atan2(accelY, sqrt(accelX * accelX + accelZ * accelZ)) * 180 / PI;
    float accelRoll  = atan2(-accelX, sqrt(accelY * accelY + accelZ * accelZ)) * 180 / PI;
    pitch = GYRO_WEIGHT * (pitch + gyroX * deltaTime) + ACCEL_WEIGHT * accelPitch;
    roll  = GYRO_WEIGHT * (roll  + gyroY * deltaTime) + ACCEL_WEIGHT * accelRoll;
}

void updateTemperature() {
    int16_t rawTemp = mpu.getTemperature();
    temperature = rawTemp / 340.0 + 36.53;
    Serial.print("Temp C ");
    Serial.println(temperature);
}

void adjustMotorSpeeds() {
    int totalAdj = abs((int)(pitch * PITCH_CORRECTION))
                 + abs((int)(roll  * ROLL_CORRECTION));
    int base = constrain(BASE_THROTTLE,
                         MIN_THROTTLE + totalAdj,
                         MAX_THROTTLE - totalAdj);

    int throttleFL = base - (int)(pitch * PITCH_CORRECTION)
                        - (int)(roll  * ROLL_CORRECTION);
    int throttleFR = base - (int)(pitch * PITCH_CORRECTION)
                        + (int)(roll  * ROLL_CORRECTION);
    int throttleBL = base + (int)(pitch * PITCH_CORRECTION)
                        - (int)(roll  * ROLL_CORRECTION);
    int throttleBR = base + (int)(pitch * PITCH_CORRECTION)
                        + (int)(roll  * ROLL_CORRECTION);

    motorFL.writeMicroseconds(constrain(throttleFL, MIN_THROTTLE, MAX_THROTTLE));
    motorFR.writeMicroseconds(constrain(throttleFR, MIN_THROTTLE, MAX_THROTTLE));
    motorBL.writeMicroseconds(constrain(throttleBL, MIN_THROTTLE, MAX_THROTTLE));
    motorBR.writeMicroseconds(constrain(throttleBR, MIN_THROTTLE, MAX_THROTTLE));

    Serial.print("FL ");
    Serial.print(throttleFL);
    Serial.print(" FR ");
    Serial.print(throttleFR);
    Serial.print(" BL ");
    Serial.print(throttleBL);
    Serial.print(" BR ");
    Serial.println(throttleBR);
}